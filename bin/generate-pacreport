#!/bin/sh --
# generate-pacreport - generate /etc/pacreport.conf from files in /etc/pacreport.d
# requires pacutils mktemp

argv0=generate-pacreport

conf=/etc/pacreport.conf
vendor_confdir=/usr/share/pacreport.d
confdir=/etc/pacreport.d

marker="# Generated by $argv0 from the files found in $confdir"

if [ -f "$conf" ]; then
    read -r head < "$conf"

    if [ "$head" != "$marker" ]; then
        printf '%s: %s: existing file was not generated\n' "$argv0" "$conf" >&2
        exit 1
    fi
fi

tmp=$(mktemp "$argv0"-XXXX)

for signal in HUP INT TERM; do
    trap 'rm -f -- "$tmp"; trap - "$signal"; kill -s "$signal" "$$"' "$signal"
done

find "$vendor_confdir" "$confdir" -type f -name '*.conf' -exec cat {} + > "$tmp"

{
    printf '%s\n' "$marker"

    # pacini merge sections https://github.com/andrewgregory/pacutils/issues/38
    pacini --section-list "$tmp" | sort -u | while read -r section; do
        printf '[%s]\n' "$section"
        pacini --section="$section" "$tmp" | sort -u
    done
} > "$conf"

rm -f -- "$tmp"
